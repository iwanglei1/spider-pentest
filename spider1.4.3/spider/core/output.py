# date: 2020/1/11 15:06
# author: liyong
import csv
from . import const


class Output(object):
    """输出文件"""

    def __init__(self, file, field):
        self.file = file
        self.field = field

    def create_file(self, data):
        """创建文件"""
        with open(self.file, 'w', newline='', encoding='gb18030') as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow(self.field)
            writer.writerows(data)
            print(f'{self.file}输出成功.')

    def append_data(self, data):
        """追加数据"""
        with open(self.file, 'a+', newline='', encoding='gb18030') as csvfile:
            writer = csv.writer(csvfile)
            writer.writerows(data)


class OutputCNNVD(Output):
    """CNNVD输出文件"""
    default_field = ['CNNVD编号', '漏洞名称', 'CNNVD等级', '发布时间', 'CNNVD链接', '漏洞全称', 'CVE编号', '更新时间', 'CVE链接',
                     '漏洞简介', '漏洞公告', 'CVE分数', 'CVE等级', 'CVSS评分', '受影响版本', '受影响产品线']

    def __init__(self, file):
        super().__init__(file, self.default_field)

    def append_data(self, data):
        """追加已监控的CNNVD数据"""
        append_data = []
        with open(self.file, 'r') as csvfile:
            reader = csv.reader(csvfile)
            column = [row[const.cnnvd_id] for row in reader]
            for d in data:
                if d[const.cnnvd_id] not in column:
                    append_data.append(d[0:const.cnnvd_href + 1])       # 只截取cnnvd信息
        with open(self.file, 'a+', newline='', encoding='gb18030') as csvfile:
            writer = csv.writer(csvfile)
            writer.writerows(append_data)
        print(f'{self.file}规则库递增{len(append_data)}条漏洞数据.')
